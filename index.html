<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Illuminarchism | The Feudal Atlas</title>

    <!-- Google Fonts for Medieval Aesthetic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=IM+Fell+English:ital@0;1&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="src/styles.css">
    <script type="module" src="src/main.js"></script>
</head>

<body>

    <div id="ui-layer">
        <header class="pointer-events-auto">
            <h1>Illumin<span>archism</span></h1>
            <div class="view-switch">
                <button class="view-btn active" id="btn-view-map">Map</button>
                <button class="view-btn" id="btn-view-timeline">Timeline</button>
            </div>

            <div class="file-controls">
                <button class="btn-text" id="btn-save" title="Download .atlas JSON">Save</button>
                <button class="btn-text" id="btn-load" title="Upload .atlas JSON">Load</button>
                <button id="btn-ontology" title="View Taxonomy">Help</button>
                <input type="file" id="file-input" accept=".json,.atlas">
            </div>
        </header>

        <div id="toolbar" class="pointer-events-auto">
            <button class="tool-btn active" data-tool="pan" title="Navigate (Left: Pan | Right: Seek)">Navigate</button>
            <div style="border-top: 1px solid var(--ink-faded); width: 100%; margin: 0.2rem 0;"></div>

            <!-- NEW: The Entity Dial (Triple Wheel) -->
            <div id="entity-dial" title="Ontology: Domain - Form - Rank">
                <div class="dial-tumbler" id="dial-domain">
                    <span class="dial-label">Dom</span>
                    <span class="dial-value" id="val-domain">POL</span>
                </div>
                <div class="dial-tumbler" id="dial-form">
                    <span class="dial-label">Frm</span>
                    <span class="dial-value" id="val-form">RLM</span>
                </div>
                <div class="dial-tumbler" id="dial-rank">
                    <span class="dial-label">Rnk</span>
                    <span class="dial-value" id="val-rank">KGD</span>
                </div>
            </div>

            <button class="tool-btn" data-tool="draw" title="Quill (Draw)">Inscribe</button>
            <button class="tool-btn" data-tool="vertex-edit" title="Edit Points">Edit</button>
            <button class="tool-btn" data-tool="transform" title="Transform (Move/Scale)">Shift</button>
            <button class="tool-btn" data-tool="erase" title="Scrape (Erase)">Scrape</button>
        </div>

    </div>

    <button id="btn-toggle-registry" title="Open Atlas Registry">Registry</button>

    <!-- Use strict display:none to hide timeline initially -->
    <div id="view-timeline" class="pointer-events-auto" style="display:none;">
        <!-- Timeline API content injected here -->
    </div>

    <!-- The Illuminated Registry (Sidebar) -->
    <div id="atlas-registry" class="pointer-events-auto">
        <div class="registry-header">
            <span>Atlas Registry</span>
            <span style="font-size:0.8rem; cursor:pointer;"
                onclick="document.getElementById('atlas-registry').classList.remove('open')">X</span>
        </div>
        <div id="registry-content"></div>
    </div>

    <!-- Ontology InfoCard -->
    <div id="ontology-modal" class="pointer-events-auto">
        <span id="modal-close">X</span>
        <h2 style="border-bottom: 2px solid var(--rubric-red); padding-bottom:0.5rem;">Help & Information</h2>

        <div class="ontology-section">
            <div class="ontology-title">Keyboard Shortcuts</div>
            <ul style="margin: 0.5rem 0; padding-left: 1.2rem; font-size: 0.9rem;">
                <li><strong>Navigate:</strong> Left Click + Drag (Pan) / Arrows</li>
                <li><strong>Inspect:</strong> Right Click (Context Menu)</li>
                <li><strong>Zoom:</strong> Scroll Wheel</li>
                <li><strong>Time:</strong> Spacebar (Play/Pause)</li>
                <li><strong>Draw:</strong> Click (Point), Middle/Enter (Finish), Esc (Cancel)</li>
                <li><strong>Edit:</strong> Drag Vertex (Move), Click Line (Split)</li>
            </ul>
        </div>

        <div class="ontology-section">
            <div class="ontology-title">Latest Changes</div>
            <ul style="margin: 0.5rem 0; padding-left: 1.2rem; font-size: 0.9rem;">
                <li><strong>Unified Nav:</strong> Pan & Inspect combined.</li>
                <li><strong>Registry:</strong> Sidebar for entity management.</li>
                <li><strong>Chronometer:</strong> Tumbler speed control.</li>
                <li><strong>Stability:</strong> Fixed app freeze bugs.</li>
            </ul>
        </div>

        <div class="ontology-section">
            <div class="ontology-title" style="color:var(--rubric-red);">Known Issues</div>
            <ul style="margin: 0.5rem 0; padding-left: 1.2rem; font-size: 0.9rem;">
                <li><strong>Performance:</strong> Lag with >1k entities.</li>
                <li><strong>Browser:</strong> Chromium recommended.</li>
            </ul>
        </div>
    </div>

    <div id="info-panel" class="pointer-events-auto">
        <input type="text" id="info-name-input" class="info-input" value="Region Name">
        <div class="info-row">
            <span>Category:</span>
            <span id="info-cat" style="font-weight:bold;">Political</span>
        </div>
        <div class="info-row">
            <span>Type:</span>
            <span id="info-type" style="font-weight:bold;">Polity</span>
        </div>
        <div class="info-row">
            <span>Pigment:</span>
            <input type="color" id="info-color-input" title="Change Color">
        </div>

        <div class="info-row">
            <span>Texture:</span>
            <select id="info-hatch-input">
                <option value="solid">Solid</option>
                <option value="diagonal-right">Diagonal (Right)</option>
                <option value="diagonal-left">Diagonal (Left)</option>
                <option value="vertical">Vertical</option>
                <option value="horizontal">Horizontal</option>
                <option value="cross">Cross Hatch</option>
                <option value="saltire">Saltire (X)</option>
                <option value="stipple">Stipple (Dots)</option>
                <option value="waves">Undy (Waves)</option>
            </select>
        </div>

        <div class="info-row"><span>Span:</span> <span id="info-span">1000-1200</span></div>
        <div class="info-row" id="info-parent-row" style="display:none;">
            <span>Fealty To:</span> <span id="info-parent" style="color:var(--lapis-lazuli);"></span>
        </div>
        <div style="margin-top: 0.5rem; font-weight: bold; color: var(--ink-faded);">Recorded Years:</div>
        <div id="keyframe-list"></div>
        <div style="display:flex; gap:0.5rem; margin-top: 1rem;">
            <button class="small-btn" id="btn-update-meta" style="flex:1;">Update</button>
            <button class="small-btn" id="btn-deselect">Close</button>
        </div>
    </div>

    <div id="draw-hint"></div>
    <!-- Button Reset View Removed -->

    <div id="temporal-controls" class="pointer-events-auto">
        <button id="btn-toggle-time-panel" title="Toggle Panel">â–¼</button>
        <div id="year-display">1000 AD</div>
        <div
            style="display:flex; justify-content:space-between; width:100%; max-width:900px; margin-bottom:0.5rem; font-size:0.8rem; color:var(--rubric-red);">
            <div style="display:flex; align-items:center; gap:0.5rem;">
                <span>Epoch Start:</span>
                <input type="number" id="epoch-start" value="-10000" class="epoch-input">
            </div>
            <div style="display:flex; align-items:center; gap:0.5rem;">
                <span>Epoch End:</span>
                <input type="number" id="epoch-end" value="2025" class="epoch-input">
            </div>
        </div>
        <div class="timeline-wrapper">
            <button id="btn-prev-key" class="time-btn" title="Previous Keyframe">Prev</button>
            <button id="btn-play" title="Play History">Play</button>
            <button id="btn-next-key" class="time-btn" title="Next Keyframe">Next</button>

            <div class="speed-control" title="Temporal Velocity (Years/Tick)">
                <div class="speed-btn-group">
                    <button class="speed-btn" data-speed="5">0.5x</button>
                    <button class="speed-btn active" data-speed="10">1x</button>
                    <button class="speed-btn" data-speed="20">2x</button>
                    <button class="speed-btn" data-speed="40">4x</button>
                    <button class="speed-btn" data-speed="80">8x</button>
                </div>
            </div>

            <div id="timeline-track-container">
                <div id="keyframe-notches"></div>
                <input type="range" id="time-slider" min="-10000" max="2025" value="1000" step="1">
            </div>
        </div>
        <div style="font-size: 0.8rem; color: var(--ink-faded);">The Chronometer</div>
    </div>

    <div class="debug-info pointer-events-auto">
        Render: Watercolor/Ink | Mode: Interactive | Entities: Loading...
    </div>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Loading Chronicle...</div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu" style="display: none;">
        <div class="menu-header" id="ctx-header">Entity Details</div>
        <div class="menu-content">
            <div class="menu-row">
                <label>Name:</label>
                <input type="text" id="ctx-name-input" class="ctx-input">
            </div>
            <div class="menu-row">
                <label>Type:</label>
                <span id="ctx-type"></span>
            </div>
            <div class="menu-row">
                <label>Span:</label>
                <div style="display:flex; gap: 4px; align-items:center;">
                    <input type="number" id="ctx-start-year" class="ctx-input-year" title="Start Year">
                    <span style="font-size: 0.8rem;">to</span>
                    <input type="number" id="ctx-end-year" class="ctx-input-year" title="End Year">
                </div>
            </div>
            <div class="menu-row">
                <label>Color:</label>
                <input type="color" id="ctx-color-input">
            </div>
            <div class="menu-row">
                <label>Texture:</label>
                <select id="ctx-hatch-input" class="ctx-input">
                    <option value="solid">Solid</option>
                    <option value="diagonal-right">Diagonal (Right)</option>
                    <option value="diagonal-left">Diagonal (Left)</option>
                    <option value="vertical">Vertical</option>
                    <option value="horizontal">Horizontal</option>
                    <option value="cross">Cross Hatch</option>
                    <option value="saltire">Saltire (X)</option>
                    <option value="stipple">Stipple (Dots)</option>
                    <option value="waves">Undy (Waves)</option>
                </select>
            </div>
        </div>
    </div>

    <canvas id="map-canvas"></canvas>

</body>

</html>
```